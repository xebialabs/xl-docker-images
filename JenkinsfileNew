#!groovy
@Library('jenkins-pipeline-libs@master')
import java.lang.Object
import com.xebialabs.pipeline.utils.Branches
import groovy.transform.Field

pipeline {
    agent none

    parameters {
        choice(
                name: 'products',
                choices: ['xl-client', 'xl-release', 'xl-deploy', 'deploy-task-engine', 'central-configuration'],
                description: 'Select the product you want to generate Docker Image for')
        string(
                name: 'version',
                defaultValue: '',
                description: "Version of the product you want to create Docker Images for (leave empty for latest)")
        string(
                name: 'branch',
                defaultValue: 'master',
                description: "Git branch to build from")
        choice(
                name: 'target_os',
                choices: ['all', 'ubuntu', 'redhat'],
                description: "Target OS for Docker Images")
        choice(
                name: 'ReleaseType',
                choices: ['nightly', 'final'],
                description: "Type of Release if it is nightly or final")
        choice(
                name: 'Registry',
                choices: ['xldevdocker', 'xebialabs', 'xebialabsunsupported', 'xebialabsearlyaccess'],
                description: "Docker Registry you want to push Docker Images to")
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '20', artifactDaysToKeepStr: '7', artifactNumToKeepStr: '5'))
        timeout(time: 1, unit: 'HOURS')
        timestamps()
        ansiColor('xterm')
    }

    environment {
        NEXUS_CRED = credentials('nexus-ci')
        SEED_VERSION = '9.6.1-alpha.4'
    }

    stages {

        stage('Rendering and Build Docker Images for XLProducts') {
            parallel {
                stage('Rendering and Build Docker Images for Linux OS') {
                    when {
                        expression {
                            (params.target_os == 'all' || params.target_os in ['ubuntu', 'redhat'])
                        }
                    }
                    agent {
                        label 'docker_linux'
                    }
                    steps {
                        // Clean old workspace
                        step([$class: 'WsCleanup'])

                        // Checkout from specified branch
                        checkout([$class: 'GitSCM',
                            branches: [[name: "*/${params.branch}"]],
                            userRemoteConfigs: scm.userRemoteConfigs
                        ])

                        // Clean docker images including volumes
                        sh '''
                            docker rm -f $(docker ps -a -q) 2>/dev/null || echo "No more containers to remove."
                            docker rmi $(docker images -q) 2>/dev/null || echo "No more images to remove."
                            docker system prune -a --volumes -f 2>/dev/null || echo "No more data to prun."
                        '''

                        // install pipenv and needed dependencies
                        sh 'pipenv install'

                        // Rendering and Committing changes
                        script {
                            def productVersion = getLatestVersion(params.products)
                            def targetOsList = getTargetOsList(params.target_os, params.products)

                            if ((params.ReleaseType == "final") && (params.Registry == "xebialabs")) {
                                sh "pipenv run ./applejack.py render --xl-version ${productVersion} --product ${params.products} --registry ${params.Registry} --commit"
                            } else {
                                sh "pipenv run ./applejack.py render --xl-version ${productVersion} --product ${params.products} --registry ${params.Registry}"
                            }

                            // Build Docker Image and push it
                            if (params.products == 'xl-client') {
                                sh "pipenv run ./applejack.py build --xl-version ${productVersion} --download-source nexus --download-username ${NEXUS_CRED_USR} --download-password ${NEXUS_CRED_PSW} --product ${params.products} --target-os alpine --push --registry ${params.Registry}"
                            } else {
                                def targetOsArgs = targetOsList.collect { "--target-os ${it}" }.join(' ')
                                sh "pipenv run ./applejack.py build --xl-version ${productVersion} --download-source nexus --download-username ${NEXUS_CRED_USR} --download-password ${NEXUS_CRED_PSW} --product ${params.products} ${targetOsArgs} --push --registry ${params.Registry}"
                            }
                        }
                        script {
                            cleanWs()
                        }
                    }
                }
            }
        }

        stage('Test Docker Images for XLProducts') {
            parallel {
                stage('Test Docker Images for Linux OS') {
                    when {
                        expression {
                            (params.target_os == 'all' || params.target_os in ['ubuntu', 'redhat'])
                        }
                    }
                    agent {
                        label 'docker_linux'
                    }
                    steps {
                        script {
                            def productVersion = getLatestVersion(params.products)

                            if (params.products == 'xl-release') {
                                // Run Docker
                                def status = sh(script: "docker run -d -e ADMIN_PASSWORD=admin -e ACCEPT_EULA=Y -p 6616:5516 --name xl-release ${params.Registry}/xl-release:${productVersion}", returnStatus: true)
                                // Result
                                if (status != 0) {
                                    currentBuild.result = 'FAILURE'
                                    error('Docker Image Start FAILED')
                                }
                                // Test if port is up
                                sh "sleep 100"
                                def pstatus = sh(script: "curl localhost:6616", returnStatus: true)
                                // Result
                                if (pstatus != 0) {
                                    currentBuild.result = 'FAILURE'
                                    error('Docker Image Start FAILED')
                                }
                            }

                            if (params.products == 'xl-deploy') {
                                // Run Docker
                                def status = sh(script: "docker run -d -e ADMIN_PASSWORD=admin -e ACCEPT_EULA=Y -p 5616:4516 --name xl-deploy ${params.Registry}/xl-deploy:${productVersion}", returnStatus: true)
                                // Result
                                if (status != 0) {
                                    currentBuild.result = 'FAILURE'
                                    error('Docker Image Start FAILED')
                                }
                                // Test if port is up
                                sh "sleep 100"
                                def pstatus = sh(script: "curl localhost:5616", returnStatus: true)
                                // Result
                                if (pstatus != 0) {
                                    currentBuild.result = 'FAILURE'
                                    error('Docker Image Start FAILED')
                                }
                            }

                            if (params.products == 'central-configuration') {
                                // Run Docker
                                def status = sh(script: "docker run -d -p 8888:8888 --name central-configuration ${params.Registry}/central-configuration:${productVersion}", returnStatus: true)
                                // Result
                                if (status != 0) {
                                    currentBuild.result = 'FAILURE'
                                    error('Docker Image Start FAILED')
                                }
                                // Test if port is up
                                sh "sleep 100"
                                def pstatus = sh(script: "curl localhost:8888", returnStatus: true)
                                // Result
                                if (pstatus != 0) {
                                    currentBuild.result = 'FAILURE'
                                    error('Docker Image Start FAILED')
                                }
                            }

                            if (params.products == 'deploy-task-engine') {
                                // Run Docker
                                def status = sh(script: "docker run -d -p 9180:8180 --name deploy-task-engine ${params.Registry}/deploy-task-engine:${productVersion}", returnStatus: true)
                                // Result
                                if (status != 0) {
                                    currentBuild.result = 'FAILURE'
                                    error('Docker Image Start FAILED')
                                }
                            }
                        }
                        script {
                            cleanWs()
                        }
                    }
                }
            }
        }
    }
    post {
        success {
            script {
                if (env.BRANCH_NAME == 'master') {
                    slackSend color: "good", tokenCredentialId: "slack-token", message: "XL Official Docker Images build *SUCCESS* - <${env.BUILD_URL}|click to open>", channel: 'docker-images-release'
                }
            }
        }
        failure {
            script {
                if (env.BRANCH_NAME == 'master') {
                    slackSend color: "danger", tokenCredentialId: "slack-token", message: "XL Official Docker Images build *FAILED* - <${env.BUILD_URL}|click to open>", channel: 'docker-images-release'
                }
            }
        }
    }
}

def getLatestVersion(xl_product) {
    script {
        // Use provided version or get latest from nexus
        if (params.version != '') {
            return params.version
        }

        def productVersion = ""
        
        switch(xl_product) {
            case 'xl-client':
                productVersion = sh(script: 'curl -su ${NEXUS_CRED} https://nexus.xebialabs.com/nexus/service/local/repositories/releases/content/com/xebialabs/xlclient/xl-client/maven-metadata.xml | grep "<release>" | cut -d ">" -f 2 | cut -d "<" -f 1 | sort -n | tail -1', returnStdout: true).trim()
                break
            case 'xl-release':
                productVersion = sh(script: 'curl -su ${NEXUS_CRED} https://nexus.xebialabs.com/nexus/service/local/repositories/releases/content/com/xebialabs/xlrelease/xl-release/maven-metadata.xml | grep "<release>" | cut -d ">" -f 2 | cut -d "<" -f 1 | sort -n | tail -1', returnStdout: true).trim()
                break
            case 'xl-deploy':
                productVersion = sh(script: 'curl -su ${NEXUS_CRED} https://nexus.xebialabs.com/nexus/service/local/repositories/releases/content/com/xebialabs/deployit/xl-deploy/maven-metadata.xml | grep "<release>" | cut -d ">" -f 2 | cut -d "<" -f 1 | sort -n | tail -1', returnStdout: true).trim()
                break
            case 'central-configuration':
                productVersion = sh(script: 'curl -su ${NEXUS_CRED} https://nexus.xebialabs.com/nexus/service/local/repositories/releases/content/ai/digital/config/central-configuration-server/maven-metadata.xml | grep "<release>" | cut -d ">" -f 2 | cut -d "<" -f 1 | sort -n | tail -1', returnStdout: true).trim()
                break
            case 'deploy-task-engine':
                productVersion = sh(script: 'curl -su ${NEXUS_CRED} https://nexus.xebialabs.com/nexus/service/local/repositories/releases/content/com/xebialabs/deployit/xl-deploy/maven-metadata.xml | grep "<release>" | cut -d ">" -f 2 | cut -d "<" -f 1 | sort -n | tail -1', returnStdout: true).trim()
                break
            default:
                error("Unknown product: ${xl_product}")
        }
        
        writeFile(file: "${env.WORKSPACE}/${xl_product}-latest", text: "${productVersion}")
        return productVersion
    }
}

def getTargetOsList(target_os, product) {
    def osList = []
    
    if (target_os == 'all') {
        if (product == 'xl-client') {
            osList = ['alpine']
        } else {
            osList = ['ubuntu', 'redhat']
        }
    } else if (target_os in ['ubuntu', 'redhat']) {
        osList = [target_os]
    }
    
    return osList
}